version: "3.9"

services:
  # Django REST backend / Бекенд на Django REST
  backend:
    build:
      context: ./backend
    env_file:
      - .env
      - backend/.env
    volumes:
      - ./backend:/app   # bind mount for live reload in dev / маунтим код для live reload
    command: python manage.py runserver 0.0.0.0:8000
    depends_on:
      - postgres
      - redis

  # Django templates + HTMX BFF / Фронт+BFF на Django templates
  frontend:
    build:
      context: ./frontend
    env_file:
      - .env
      - frontend/.env
    volumes:
      - ./frontend:/app   # maунтим фронтовый код
    command: python manage.py runserver 0.0.0.0:8001
    depends_on:
      - backend   # needs API / зависит от backend
      - redis

  # Celery worker (reuse backend image) / Celery worker (использует образ backend)
  celery:
    build:
      context: ./backend
    env_file:
      - .env
      - backend/.env
    command: celery -A config worker -l info
    depends_on:
      - backend
      - redis
      - postgres

  # Celery beat scheduler / Планировщик Celery beat
  celery-beat:
    build:
      context: ./backend
    env_file:
      - .env
      - backend/.env
    command: celery -A config beat -l info
    depends_on:
      - backend
      - redis
      - postgres

  # PostgreSQL database / База данных PostgreSQL
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-crm_dev}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-crm_dev}
      POSTGRES_DB: ${POSTGRES_DB:-crm_dev}
    volumes:
      - pg_data:/var/lib/postgresql/data

  # Redis for cache/broker / Redis для кэша/брокера
  redis:
    image: redis:7

  # Reverse proxy for dev parity / Nginx как reverse proxy для локалки
  nginx:
    image: nginx:1.25
    ports:
      - "${NGINX_PORT:-8000}:80"
    volumes:
      - ./infra/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend

volumes:
  pg_data: {}
